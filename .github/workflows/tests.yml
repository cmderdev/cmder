name: Run Tests

on:
  push:
    branches:
      - master
      - development
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.github/**'
      - '**/.gitignore'
  pull_request:
    branches:
      - master
      - development
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.github/**'
      - '**/.gitignore'

defaults:
  run:
    shell: cmd

permissions:
  contents: read

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:

  tests:
    runs-on: windows-latest
    continue-on-error: false

    steps:
    - uses: actions/checkout@v6

    - name: Summary - Test execution started
      shell: pwsh
      run: |
        echo "## ðŸ§ª Run Tests - Workflow Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### Test Environment" >> $env:GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $env:GITHUB_STEP_SUMMARY
        echo "| --- | --- |" >> $env:GITHUB_STEP_SUMMARY
        echo "| Repository | \`${{ github.repository }}\` |" >> $env:GITHUB_STEP_SUMMARY
        echo "| Branch | \`${{ github.ref_name }}\` |" >> $env:GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $env:GITHUB_STEP_SUMMARY
        echo "| Runner OS | \`${{ runner.os }}\` |" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY

    - name: Initialize vendors
      shell: pwsh
      working-directory: scripts
      run: .\build.ps1 -verbose

    - name: Summary - Vendor initialization
      if: success()
      shell: pwsh
      run: |
        echo "### âš™ï¸ Vendor Initialization" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "âœ… Vendor dependencies initialized successfully." >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY

    - name: Summary - Test results table header
      if: success()
      shell: pwsh
      run: |
        echo "### ðŸ“‹ Test Results" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "| Test | Status |" >> $env:GITHUB_STEP_SUMMARY
        echo "| --- | --- |" >> $env:GITHUB_STEP_SUMMARY

    - name: Testing Clink Shell
      run: |
          cmd /c vendor\init.bat /v /d /t

    - name: Summary - Clink Shell test
      if: success()
      shell: pwsh
      run: |
        echo "| Clink Shell | âœ… Passed |" >> $env:GITHUB_STEP_SUMMARY
    - name: Testing PowerShell
      run: |
          PowerShell.exe -ExecutionPolicy Bypass -NoLogo -NoProfile -Command "$env:CMDER_DEBUG='1'; . 'vendor\profile.ps1'"

    - name: Summary - PowerShell test
      if: success()
      shell: pwsh
      run: |
        echo "| PowerShell | âœ… Passed |" >> $env:GITHUB_STEP_SUMMARY
    - name: Testing Bash
      run: |
          bash vendor/cmder.sh

    - name: Summary - Bash test
      if: success()
      shell: pwsh
      run: |
        echo "| Bash | âœ… Passed |" >> $env:GITHUB_STEP_SUMMARY

    - name: Summary - All tests completed
      if: success()
      shell: pwsh
      run: |
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### âœ… All Tests Completed" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "All shell environments tested successfully!" >> $env:GITHUB_STEP_SUMMARY
